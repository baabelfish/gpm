#!/bin/bash
source $TPM_PACKAGES/tpm/helpers.sh

IFS=$'\n'

COMMAND=''
PACKAGES=()
PARAM_NOCOLOR=0
PARAM_NOCONFIRM=0
PARAM_QUIET=0
PARAM_VERBOSE=0

printHelp() {
    echo "\
Usage: tpm [option] <command>

command := disable [packages] |
           enable [packages]  |
           history [packages] |
           install [packages] |
           list [packages]    |
           remove [packages]  |
           search [packages]  |
           update [packages]  |

option := --help | --nocolor | --noconfirm | --quiet | --verbose
"
exit 1
}

[[ -z $1 ]] && printHelp

setCommand() {
    if [[ ! -z $COMMAND ]]; then
        PACKAGES=("${PACKAGES[@]}" "$C")
    else
        COMMAND=$1
    fi
}

commandDisable() {
    echo "UNDER CONSTRUCTION: commandDisable"
}

commandEnable() {
    echo "UNDER CONSTRUCTION: commandEnable"
}

commandInfo() {
    if [[ ${#PACKAGES[@]} -ne 1 ]]; then
        echo "You must provide one package name"
    else
        cd $TPM_PACKAGES/$i
        git log
    fi
}

commandInstall() {
    echo "UNDER CONSTRUCTION: commandInstall"
}

commandList() {
    PACKAGES=($(ls $TPM_PACKAGES))
    for i in ${PACKAGES[@]}; do
        cd $TPM_PACKAGES/$i
        echo -e "${C_PACKAGE_NAME}$i${default}    (${C_PACKAGE_UPDATED}updated${default}: $(git log -1|grep '^Date'|cut -f2- -d':'|sed 's/^ *//g'))"
    done
}

commandRemove() {
    # TODO Remove symlinks
    # TODO Remove all not in tmp.json file
    for i in ${PACKAGES[@]}; do
        if [[ -d "$TPM_PACKAGES/$i" ]]; then
            rm -rf "$TPM_PACKAGES/$i"
            echo -e "${C_REMOVING}Removed${default}: ${bold}$i${default}"
        else
            echo -e "${C_ERROR}${bold}No such package${default}: ${bold}$i"
        fi
    done
}

commandSearch() {
    echo "UNDER CONSTRUCTION: commandSearch"
}

commandUpdate() {
    # TODO Clean output
    PACKAGES=($(ls $TPM_PACKAGES))
    for i in ${PACKAGES[@]}; do
        cd $TPM_PACKAGES/$i
        git submodule update --init --recursive
        git pull
    done
}


for C in ${*}; do
    case $C in
        'disable') setCommand 'disable' ;;
        'enable')  setCommand 'enable' ;;
        'info')    setCommand 'info' ;;
        'install') setCommand 'install' ;;
        'list')    setCommand 'list' ;;
        'remove')  setCommand 'remove' ;;
        'search')  setCommand 'search' ;;
        'update')  setCommand 'update' ;;
        '--help')
            printHelp
            exit 1
            ;;
        '--nocolor')   PARAM_NOCOLOR=1 ;;
        '--noconfirm') PARAM_NOCONFIRM=1 ;;
        '--quiet')     PARAM_QUIET=1 ;;
        '--verbose')   PARAM_VERBOSE=1 ;;
        *)
            PACKAGES=("${PACKAGES[@]}" "$C")
            ;;
    esac
done

case $COMMAND in
    'disable') commandDisable ;;
    'enable')  commandEnable ;;
    'info')    commandInfo ;;
    'install') commandInstall ;;
    'list')    commandList ;;
    'remove')  commandRemove ;;
    'search')  commandSearch ;;
    'update')  commandUpdate ;;
    *)
        echo "Invalid command"
        exit 1
        ;;
esac
